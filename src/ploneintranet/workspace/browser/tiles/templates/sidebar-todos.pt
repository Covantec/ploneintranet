<div class="visible"
     id="workspace-tickets"
     tal:define="
       ws view/workspace;
       ws_view nocall:ws/@@view;
       tasks ws_view/tasks;
       token context/@@authenticator/token;
       can_add view/can_add;
     "
     i18n:domain="ploneintranet"
>
  <div class="button-bar functions"
       id="tasks-functions"
  >
    <div class="quick-functions">
      <a class="toggle-sidebar-size pat-toggle"
         title="expand/reduce sidebar"
         data-pat-toggle="selector: #application-body; value: sidebar-normal sidebar-large"
         i18n:attributes="title"
         i18n:translate=""
      >Expand sidebar</a>
      <a class="create-document pat-modal icon-doc-text"
         href="${ws/absolute_url}/@@add_task"
         title="Create new task"
         data-pat-inject="source:#content"
         data-pat-modal="class: large"
         tal:condition="can_add"
         i18n:attributes="title"
         i18n:translate=""
      >Create task</a>
    </div>
  </div>
  <h3 i18n:translate="">General tasks</h3>
  <tal:no-tasks condition="python:not ws.is_case and not tasks">
    <p i18n:translate="no-task-found">No tasks created yet</p>
  </tal:no-tasks>
  <tal:tasks condition="python:ws.is_case or tasks">
    <form class="pat-autosubmit pat-inject"
          action="${ws/absolute_url}/@@sidebar.todos"
          method="post"
          data-pat-inject="source: #workspace-tickets; target: #workspace-tickets"
    >
      <tal:workspace_tasks tal:condition="not: ws/is_case">
        <fieldset class="object-list tasks pat-checklist">
          <tal:task repeat="task tasks">
            <br />
            <label id="todo-${task/id}"
                   tal:define="
                     read_only not:task/can_edit;
                   "
            >
              <input checked="${python: 'checked' if task['checked'] else None}"
                     disabled="${python:read_only and 'disabled' or None}"
                     name="active-tasks:list"
                     type="checkbox"
                     value="${task/id}"
              />
              <a class="pat-inject follow pat-switch"
                 href="${task/url}"
                 title="${task/title}"
                 data-pat-inject="source: #document-body; target: #document-body"
                 data-pat-switch="body focus-* focus-document &amp;&amp; body sidebar-large sidebar-normal"
              >${task/title}</a>
              <div class="additional-meta-data"
                   metal:define-macro="additional-meta-data"
                   tal:define="
                     assignee task/obj/assignee;
                     initiator task/obj/initiator;
                   "
              >
                <a class="assignee meta-column icon-user pat-inject"
                   href="${context/portal_url}/profiles/${assignee}#document-body"
                   title="Assignee"
                   data-pat-inject="source: #document-body; target: #document-body"
                   tal:condition="assignee"
                >
                  ${python:ws_view.get_principal_title(assignee)}
                </a>
                <a class="assignee meta-column icon-user"
                   title="Assignee"
                   tal:condition="not:assignee"
                ></a>

                <time class="due-date meta-column icon-clock pat-display-time"
                      datetime="${task/due}"
                      title="Due date"
                      data-pat-display-time="from-now: true; locale: ${here/plone_portal_state/language}"
                      tal:condition="task/due"
                ></time>
                <time class="due-date meta-column icon-clock"
                      tal:condition="not:task/due"
                ></time>
                <a class="initiator meta-column icon-manager pat-inject"
                   href="${context/portal_url}/profiles/${initiator}#document-body"
                   title="Initiator"
                   data-pat-inject="source: #document-body; target: #document-body"
                   tal:condition="initiator"
                >
                  ${python:ws_view.get_principal_title(initiator)}
                </a>
                <a class="initiator meta-column icon-manager"
                   title="Initiator"
                   tal:condition="not:initiator"
                ></a>
              </div>
              <input name="current-tasks:list"
                     type="hidden"
                     value="${task/id}"
              />
            </label>
          </tal:task>
        </fieldset>
      </tal:workspace_tasks>
      <tal:case_tasks define="
                        milestones ws_view/metromap_sequence | nothing;
                      "
                      condition="ws/is_case"
      >
        <tal:milestone_id repeat="milestone_id milestones">
          <tal:milestone define="
                           milestone python:milestones[milestone_id];
                         "
          >
            <fieldset class="object-list tasks pat-checklist pat-collapsible ${collapsible_status}"
                      id="milestone-${milestone_id}"
                      data-pat-collapsible="${python:task_milestone and 'store: none' or 'store: session'}"
                      tal:define="
                        task_milestone python:view.is_open_task_in_milestone(tasks[milestone_id]);
                        is_current python:milestone['is_current'];
                        finished python:milestone['finished'];
                        state python: is_current and 'current' or finished and 'finished' or 'planned';
                        collapsible_status python:(task_milestone or is_current) and 'open' or 'closed';
                      "
            >
              <h4 class="section-label state-${state}"
                  i18n:translate=""
              >${milestone/title}</h4>
              <tal:task repeat="task python:tasks[milestone_id]">
                <label id="todo-${task/id}"
                       tal:define="
                         read_only not:task/can_edit;
                       "
                >
                  <input checked="${python:'checked' if task['checked'] else None}"
                         disabled="${python:read_only and 'disabled' or None}"
                         name="active-tasks:list"
                         type="checkbox"
                         value="${task/id}"
                  />
                  <input name="disabled-checked-tasks:list"
                         type="hidden"
                         value="${task/id}"
                         tal:condition="python: read_only and task['checked']"
                  />
                  <input name="checked-tasks:list"
                         type="hidden"
                         value="${task/id}"
                         tal:condition="python: not read_only and task['checked']"
                  />
                  <a class="pat-inject follow pat-switch"
                     href="${task/url}"
                     title="${task/title}"
                     data-pat-inject="source: #document-body; target: #document-body"
                     data-pat-switch="body focus-* focus-document &amp;&amp; body sidebar-large sidebar-normal"
                  >${task/title}</a>
                  <input name="current-tasks:list"
                         type="hidden"
                         value="${task/id}"
                  />
                </label>
              </tal:task>
              <p class="button-bar">
                <a class="icon-plus-circle small button pat-modal"
                   href="${ws/absolute_url}/add_task?milestone=${milestone_id}"
                   data-pat-inject="source:#content"
                   data-pat-modal="class: large"
                   tal:condition="can_add"
                   i18n:translate=""
                >Create new task</a>
                <a class="small icon-stage success button pat-inject"
                   href="${ws/absolute_url}/content_status_modify?workflow_action=${milestone/transition_id}&amp;_authenticator=${token}"
                   data-pat-inject="source:#workspace-tickets; target:#workspace-tickets &amp;&amp; source:#document-body; target:#document-body"
                   tal:condition="python:milestone['transition_enabled']"
                   i18n:translate=""
                >Close milestone</a>
                <a class="small icon-stage success button pat-inject"
                   href="${ws/absolute_url}/content_status_modify?workflow_action=${milestone/reopen_transition}&amp;_authenticator=${token}"
                   data-pat-inject="source:#workspace-tickets; target:#workspace-tickets  &amp;&amp; source:#document-body; target:#document-body"
                   tal:condition="python:milestone['reopen_transition']"
                   i18n:translate=""
                >Reopen milestone</a>
              </p>
            </fieldset>
          </tal:milestone>
        </tal:milestone_id>
        <fieldset class="task-list pat-checklist"
                  tal:define="
                    uatasks python:tasks['unassigned'];
                  "
                  tal:condition="uatasks"
        >
          <h3 class="section-label"
              i18n:translate=""
          >
            Unassigned
          </h3>
          <label id="todo-${task/id}"
                 tal:repeat="task uatasks"
          >
            <input checked="${python:'checked' if task['checked'] else None}"
                   name="active-tasks:list"
                   type="checkbox"
                   value="${task/id}"
            />
            <a class="pat-inject"
               href="${task/url}"
               title="${task/title}"
               data-pat-inject="source: #document-body; target: #document-body; history: record"
            >${task/title}</a>
            <input name="current-tasks:list"
                   type="hidden"
                   value="${task/id}"
            />
          </label>
        </fieldset>

      </tal:case_tasks>

      <input name="section"
             type="hidden"
             value="task"
      />
    </form>

  </tal:tasks>
</div>
