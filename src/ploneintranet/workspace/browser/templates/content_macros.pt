<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      i18n:domain="ploneintranet">
  <body>

    <metal:task_fields i18n:domain="ploneintranet"
        define-macro="task_fields"
        tal:define="chv here/content_helper_view;
            read_only read_only|not:view/can_edit;
            value python: context.portal_type=='todo' and context.description or '';
        ">
      <label class="description">
          <span tal:omit-tag="" i18n:translate="">Description</span> <textarea name="description" tal:attributes="disabled read_only" placeholder="Enter a description of the task" rows="6" title="Description" i18n:attributes="placeholder; title">${value}</textarea>
      </label>
      <label class="initiator"
             tal:define="current_member context/@@plone_portal_state/member;
                         default_prefill python:request.method == 'GET' and current_member.getId()">
        <span tal:omit-tag="" i18n:translate="">Initiator</span> <input class="pat-autosuggest users"  type="text" name="initiator" placeholder="Pick an initiator" i18n:attributes="placeholder"
        data-pat-autosuggest="ajax-data-type: json; maximum-selection-size: 1; selection-classes: {}; ajax-url: ${workspace_url}/allusers.json; allow-new-words: false; prefill-json: ${python:chv.safe_member_prefill(context, attrs['name'], default=default_prefill)}"
        tal:attributes="disabled read_only"
        />
      </label>
      <br/>
      <label class="assignee">
        <span tal:omit-tag="" i18n:translate="">Assignee</span>
        <input class="pat-autosuggest users"
               name="assignee"
               placeholder="Pick an assignee"
               i18n:attributes="placeholder"
               data-pat-autosuggest="ajax-data-type: json; maximum-selection-size: 1; selection-classes: {}; ajax-url: ${workspace_url}/allusers.json; allow-new-words: false; prefill-json: ${python:chv.safe_member_prefill(context, attrs['name'])}"
               tal:attributes="disabled read_only"
                />
      </label>
      <br/>
      <label class="date-time">
        <span tal:omit-tag="" i18n:translate="">Due date</span>
        <input type="date"
               name="due"
               value="${context/due | nothing}"
               tal:attributes="disabled read_only"
               data-pat-autosubmit="delay: defocus"
               data-pat-date-picker="i18n: ${context/portal_url}/@@date-picker-i18n.json"
               class="pat-date-picker" i18n:attributes="placeholder" placeholder="Set a deadline"/>
      </label>
      <br/>
      <tal:case_todo condition="milestone_options"
                     define="
                       milestone_options view/milestone_options|nothing;
                     ">
        <label class="stage milestone">
          <span tal:omit-tag="" i18n:translate="">Milestone this task belongs to</span>
          <select name="milestone">
            <option></option>
            <option value="${option/value}"
                    selected="${option/selected}"
                    tal:repeat="option milestone_options"
            >${option/title}</option>
          </select>
        </label>
        <br />
      </tal:case_todo>
    </metal:task_fields>

    <metal:event_fields define-macro="event_fields" i18n:domain="ploneintranet"
                        tal:define="read_only python:not view.can_edit;chv here/content_helper_view;">
      <metal:extra-fields-top define-slot="extra-fields-top"/>

      <input type="hidden" name="app" value="${request/app | nothing}" />
      <label class="calendar" tal:condition="request/app | nothing">
                <span tal:omit-tag="" i18n:translate="">Calendar</span>
          <select name="container"
                  required="required"
                  tal:define="
                    workspaceuid workspace/UID;
                  "
          >
            <option value="" i18n:translate="">-- Please select a workspace --</option>
            <tal:repeat repeat="uw here/content_helper_view/get_writable_user_workspaces">
                <option selected="${python: 'selected' if workspaceuid == uw.UID else None}"
                        value="${uw/getPath}"
                >${uw/Title}</option>
            </tal:repeat>
          </select>
      </label>
      <fieldset
          class="description"
          tal:define="
            is_view python: view.__name__ != 'add_event';
            value python: is_view and context.description or '';
          "
        >
        <legend i18n:translate="">Notes</legend>
        <div class="textarea group">
            <p class="mirror-target" id="ticket-description">${value}</p>
            <textarea name="description"
                      class="pat-content-mirror focus"
                      disabled="${python:read_only and 'disabled' or None}"
                      data-pat-content-mirror="target: #ticket-description"
                      placeholder="Event description"
                      rows="6"
                      i18n:attributes="placeholder"
                    >${value}</textarea>
        </div>
      </fieldset>
      <br />

      <label class="location">
        <span tal:omit-tag="" i18n:translate="">Location</span> <input
        placeholder="Enter a location"
        i18n:attributes="placeholder"
        name="location" tal:attributes="disabled read_only" value="${context/location | nothing}" type="text" value="" />
      </label>
      <br/>
      <label class="organiser">
        <span tal:omit-tag="" i18n:translate="">Organiser</span>
        <input type="text"
               name="organizer"
               data-pat-autosuggest="ajax-data-type: json; maximum-selection-size: 1; ajax-url: ${workspace_url}/members.json; prefill-json: ${python:chv.safe_member_prefill(context, attrs['name'])}"
               class="pat-autosuggest users"
               placeholder="Name of organiser"
               i18n:attributes="placeholder"
               tal:attributes="disabled read_only"/>
      </label>
      <br/>
      <fieldset class="pat-checklist options">
        <label>
          <input name="whole_day" value="selected" tal:attributes="disabled read_only; checked python:getattr(context, 'whole_day', 0)" type="checkbox"/>
          <input name="whole_day-empty-marker" type="hidden" value="1" />
          <span tal:omit-tag="" i18n:translate="">All day event</span>
        </label>
<!--        <br/>
        <label>
          <input type="checkbox" tal:attributes="disabled read_only"/> <span tal:omit-tag="" i18n:translate="">Visible on other calendars</span>
        </label> -->
      </fieldset>
      <br/>
      <fieldset class="group date-time">
        <fieldset class="row group"
                tal:define="dt python:modules['DateTime'].DateTime();
                            start_id string:event-start-date-${dt/millis};
                            end_id string:event-end-date-${dt/millis}">
          <fieldset class="group six columns">
            <legend i18n:translate="">From</legend>

            <div class="row"
                 tal:define="start context/start | view/default_start">
              <label class="seven columns">
                <input class="date pat-date-picker"
                       id="${start_id}"
                       name="start"
                       type="date"
                       required="required"
                       disabled="${python:'disabled' if read_only else None}"
                       size="10"
                       placeholder="Date"
                       value="${python:start and start.strftime('%Y-%m-%d')}"
                       data-pat-date-picker="i18n: ${context/portal_url}/@@date-picker-i18n.json"
                       data-pat-validation="type: date; not-after: #${end_id}; message-date: This date must be on or before the end date."
                       i18n:attributes="placeholder"
                />
              </label>
              <label class="five columns">
                <input type="time" size="10" class="time" name="start" placeholder="Time"
                       i18n:attributes="placeholder"
                       tal:attributes="disabled read_only"
                       value="${python:start and start.strftime('%H:%M')}"/>
              </label>
            </div>
          </fieldset>

          <fieldset class="group six columns">
            <legend i18n:translate="">Until</legend>
            <div class="row"
                 tal:define="end context/end | view/default_end">
              <label class="seven columns">
                <input class="date pat-date-picker"
                       id="${end_id}"
                       name="end"
                       type="date"
                       required="required"
                       disabled="${python:'disabled' if read_only else None}"
                       size="10"
                       placeholder="Date"
                       value="${python:end and end.strftime('%Y-%m-%d')}"
                       data-pat-date-picker="i18n: ${context/portal_url}/@@date-picker-i18n.json"
                       data-pat-validation="type: date; not-before: #${start_id}; message-date: this date must be on or after the start date."
                       i18n:attributes="placeholder"
                />
              </label>
              <label class="five columns">
                <input type="time" size="10" class="time" name="end" placeholder="Time"
                       i18n:attributes="placeholder"
                       tal:attributes="disabled read_only"
                       value="${python:end and end.strftime('%H:%M')}"/>
              </label>
            </div>
          </fieldset>
        </fieldset>

        <label class="timezone" tal:condition="not:view/hide_timezone|nothing"><span tal:omit-tag="" i18n:translate="">Timezone</span>
            <select class="timezone" name="timezone" tal:attributes="disabled read_only">
                <option tal:repeat="tz here/content_helper_view/get_tz_options;"
                    data-timezone-id="${tz/id}"
                    gmt-adjustment="${tz/gmt_adjustment}"
                    data-use-daylight-time="${tz/use_daylight}"
                    selected="${tz/selected}"
                    value="${tz/value}">${tz/label}</option>
            </select>
        </label>

      </fieldset>
      <br/>

      <label class="invitees"><span tal:omit-tag="" i18n:translate="">Invitees</span>
      <input name="invitees" type="text" placeholder="Invitees" i18n:attributes="placeholder" class="pat-autosuggest users" tal:attributes="disabled read_only"
             data-pat-autosuggest-classes=''
             tal:define="selection_classes python:view.get_selection_classes(field='invitees')"
             data-pat-autosuggest="ajax-data-type: json; selection-classes: ${selection_classes}; ajax-url: ${here/portal_url}/allusers-and-groups.json; prefill-json: ${python:chv.safe_member_and_group_prefill(context, attrs['name'])}"/>
      <span class="legend" tal:condition="nothing">
        <dfn class="undecided" i18n:translate="">Undecided</dfn>
        <dfn class="confirmed" i18n:translate="">Confirmed</dfn>
        <dfn class="tentative" i18n:translate="">Tentative</dfn>
        <dfn class="declined" i18n:translate="">Declined</dfn>
      </span>

      </label>

    </metal:event_fields>

    <metal:saving_badge define-macro="saving_badge">
      <p id="saving-badge"
         class="saving-badge"
         tal:define="
           toLocalizedtime nocall:here/@@plone/toLocalizedTime;
           last_modified python:toLocalizedtime(here.modified(), long_format=1);
         ">
        <button
             type="submit"
             class="saved-tag focus"
             disabled="${python: read_only and 'disabled' or None}"
          ><tal:t i18n:translate="">Last saved</tal:t>
          <time class="modification-date pat-display-time" data-pat-display-time="from-now: true; locale: ${context/plone_portal_state/language}" datetime="${here/ModificationDate}">${last_modified}</time>
        </button>
      </p>
    </metal:saving_badge>

  </body>
</html>
