<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="ploneintranet">

  <body>
        <metal:statusmessage fill-slot="statusmessage" tal:define="suppress_message python:request.get('suppress_message', False)">
          <metal:macro tal:condition="not:suppress_message" use-macro="context/main_template/macros/statusmessage" />
        </metal:statusmessage>
    <metal:content fill-slot="content"
                   tal:define="workspace python:view.workspace;
                               here_url context/absolute_url;
                               workspace_url workspace/absolute_url;
                               workspace_id python:workspace.id">

      <div class="application" id="app-space">
        <div id="application-body"
             class="application page-type-${type} workspace-type-${type} sidebar-left-closed"
             tal:define="
               type workspace/ws_type | string:workspace;
               autosave_enabled view/autosave_enabled|nothing;
               form_injection_elementid python:autosave_enabled and 'saving-badge' or 'document-body';
             "
            >
          <h1 id="workspace-name">
            <a href="${workspace_url}" tal:content="workspace/Title">Title</a>
          </h1>
          <div class="${workspace_id}" id="project-body" tal:define="read_only python:not view.can_edit">
            <div id="document-body">
              <form class="document pat-inject ${python:autosave_enabled and 'pat-autosubmit' or ''} document-type-${view/portal_type_to_class}"
                    method="POST"
                    action="${context/absolute_url}/view"
                    enctype="multipart/form-data"
                    id="document-form"
                    data-pat-autosubmit="${python:autosave_enabled and 'delay: 20000ms' or None}"
                    data-pat-inject="${python: (not autosave_enabled) and '#global-statusmessage; target:#global-statusmessage; loading-class: \'\' &amp;&amp;' or ''} source: #${form_injection_elementid}; target: #${form_injection_elementid}; &amp;&amp; source: #sidebar; target: #sidebar; loading-class: ''">
                <div class="metadata pat-bumper sticky-supported" id="meta">
                  <div class="meta-bar">
                    <button class="pat-switch back-to-parent icon-left-open" data-pat-switch="body focus-* focus-sidebar">${context/aq_inner/aq_parent/title}</button>
                    <span class="title-group">
                      <h1 class="doc-title" id="document-title">${context/title}</h1>
                      <textarea name="title" tal:attributes="disabled read_only" type="text" maxlength="70" placeholder="Document title" class="doc-title pat-content-mirror" data-pat-content-mirror="target: #document-title">${context/title}</textarea>
                    </span>

                    <div class="quick-functions">

                      <a class="icon-ellipsis iconified pat-tooltip" data-pat-tooltip="source: ajax" title="Show extra context actions" i18n:attributes="title" i18n:translate="" href="${context/absolute_url}/context-menu#content">Show extra context actions</a>
                      <!--a href="" class="icon-copy iconified" title="Copy this document" i18n:attributes="title" i18n:translate="">Copy</a-->

                      <a tal:condition="python:context.portal_type == 'Link'" href="${context/remoteUrl}" class="icon-globe iconified" target="External" title="Open web page in new window">
                        Open web page in new window
                      </a>

                      <a href="#share-panel" class="icon-export iconified pat-tooltip" data-pat-tooltip="source: ajax" title="Share this document" i18n:attributes="title" i18n:translate="">Share</a>

                      <tal:bookmark replace="structure here/@@bookmark-link-iconified|nothing" />

                      <fieldset tal:condition="view/has_workflow" id="workflow-menu" class="pat-subform pat-autosubmit pat-inject"
                                tal:attributes="data-pat-inject string:target: #global-statusmessage;; url: ${here_url}/view;; source: #global-statusmessage &amp;&amp; url: ${here_url}/view;; source: #application-body;; target: #application-body">
                        <label class="pat-select bare workflow" title="Change the workflow state" i18n:attributes="title">
                          <select name="workflow_action" id="workflow_action">
                            <option tal:repeat="state view/get_workflow_transitions"
                                    tal:attributes="title state/title; value state/action; selected state/selected|nothing"
                                    tal:content="state/title">Workflow State</option>
                          </select>
                        </label>
                        <span tal:replace="structure context/@@authenticator/authenticator"/>
                      </fieldset>
                      <tal:autosaveon condition="autosave_enabled">
                        <metal:macro use-macro="context/content_macros/saving_badge" />
                      </tal:autosaveon>
                      <tal:autosaveoff condition="not:autosave_enabled">
                        <button type="submit" tal:condition="not:read_only" class="icon-floppy" i18n:translate="">Save</button>
                      </tal:autosaveoff>

                      <a class="icon-down-open meta-data-toggle iconified pat-toggle" data-pat-toggle="selector: #document-form; value: more-metadata less-metadata" title="Show extra metadata fields" i18n:attributes="title" i18n:translate="">Toggle extra metadata</a>


                    </div><!-- quick-functions -->
                  </div> <!-- #meta-bar -->
                  <div tal:condition="python:context.portal_type == 'Document' and not read_only" id="editor-toolbar" class="bar redactor"><p class="loader" i18n:translate="">Loading...</p></div>

                  <fieldset class="pat-collapsible closed meta-extra" data-pat-collapsible="trigger: .meta-data-toggle" id="meta-extra">
                      <div class="panel-content" style="display:none">
                          <fieldset class="bar">
                            <input type="text"
                                   name="subjects" placeholder="Tags"
                                   i18n:domain="plone" i18n:attributes="placeholder"
                                   value="${python:','.join(context.subject)}"
                                   tal:attributes="disabled read_only"
                                   class="pat-autosuggest"
                                   data-pat-autosuggest="ajax-data-type: json; ajax-search-index: text; ajax-url:${context/absolute_url}/@@getVocabulary?resultsonly=1&amp;name=ploneintranet.network.vocabularies.Keywords&amp;field=subjects"/>
                          </fieldset>

                          <fieldset class="bar description">
                            <textarea name="description" tal:attributes="disabled read_only" rows="8" title="Description" placeholder="Description">${context/description}</textarea>
                          </fieldset>

                          <fieldset class="bar versioning pat-inject pat-subform" tal:condition="python:context.portal_type in ('File', 'Image')"
                                    data-pat-inject="source: #document-content; target: #document-content && source: fieldset.versioning; target: fieldset.versioning; loading-class: ''">
                              <label class="pat-checklist">
                                <input type="checkbox" name="cmfeditions_save_new_version" id="cmfeditions_save_new_version" /> Save a new version
                              </label>
                              <fieldset class="condensed pat-depends new-version-details pat-inject" data-pat-depends="cmfeditions_save_new_version">
                                  <label tal:condition="python: context.portal_type == 'File'">
                                      Upload a new file <input type="file" class="file" name="file"/>
                                  </label>
                                  <label tal:condition="python: context.portal_type == 'Image'">
                                      Upload a new image <input type="file" class="image" name="image"/>
                                  </label>

                                  <label>
                                      <textarea placeholder="Change notes" tal:condition="view/is_versionable" name="cmfeditions_version_comment" id="cmfeditions_version_comment" cols="80" rows="4" tal:attributes="value request/form/cmfeditions_version_comment | nothing"></textarea>
                                  </label>

                                  <button type="submit" name="submit" value="submit" class="submit">Save this version</button>
                                  <input type="hidden" name="redirect" tal:attributes="value string:${context/absolute_url}/view" />
                              </fieldset>
                          </fieldset>
                          <fieldset class="bar link pat-inject pat-subform" tal:condition="python:context.portal_type in ('Link')"
                                    data-pat-inject="source: #document-content; target: #document-content;">
                            <input tal:condition="not:read_only"
                                   name="remoteUrl"
                                   type="text"
                                   size="80"
                                   required="required"
                                   value="${context/remoteUrl}"
                              />
                            <a tal:condition="read_only"
                               href="${context/remoteUrl}"
                              >${context/remoteUrl}</a>
                          </fieldset>
                      </div>
                  </fieldset>
                </div><!-- pat-bumper -->

                <div id="document-content">
                  <article class="document rich"
                           tal:condition="python: context.portal_type == 'Document'">
                    <textarea tal:condition="not:read_only"
                              name="text"
                              class="pat-redactor ${python:context.text and 'has-content' or 'has-no-content'}"
                              data-pat-redactor="imageupload: ${workspace_url}/fileUpload; imagegetjson: ${workspace_url}/@@images.json; imageresizable: true; toolbar-external: #editor-toolbar; allowed-tags: p, ul, li, ol, strong, em, a, img, video, embed, object, h1, h2, h3, h4, h5, table, thead, tbody, th, tr, td, iframe, figure, figcaption; buttons: format, bold, italic, deleted, lists, link, horizontalrule, image; formatting: p, pre, h1, h2, h3; plugins: alignment,table,source,video,imagemanager"
                              placeholder="Write your text here"
                              i18n:attributes="placeholder;"
                         >${python: context.text.raw if context.text and hasattr(context.text, 'raw') else ''}</textarea>
                    <span tal:condition="python:read_only and context.text and hasattr(context.text, 'raw')" tal:replace="structure context/text/output" />
                  </article>

                  <tal:c condition="python: context.portal_type == 'File'">
                    <article class="document preview" tal:condition="view/is_available">
                      <tal:previews tal:repeat="preview view/previews">
                        <img src="${preview}" />
                      </tal:previews>
                    </article>
                    <article class="document preview" tal:condition="not:view/is_available">
                      <p class="message no-preview">
                            <strong class="title" tal:content="context/Title">projection-material.doc</strong>
                            <!-- If a preview CANNOT be generated due to a server error or an unsupported file format, then display the following text in the below byline "No preview available". -->
                            <em class="byline" tal:condition="view/is_allowed_document_type" i18n:translate="">Preview being generated</em>
                            <em class="byline" tal:condition="not:view/is_allowed_document_type" i18n:translate="">No preview available</em>
                      </p>
                    </article>
                  </tal:c>

                  <article class="document preview" tal:condition="python: context.portal_type == 'Image'">
                    <figure tal:define="modified context/modified|nothing">
                      <img src="${view/image_url}?timestamp=${modified/ISO|nothing}" title="${context/title}" alt="${context/title}" />
                    </figure>
                  </article>

                  <div id="external-site-preview" tal:condition="python: context.portal_type == 'Link'">
                    <iframe src="${context/remoteUrl}" class="preview-pane"></iframe>
                  </div>

              </div><!-- #document-content -->
              <input type="hidden" name="form.submitted" value="1" />
            </form>

              <div tal:replace="structure context/@@content-stream.html">
                #comments-document-comments document discussion goes here
                implementation is in ploneintranet.activitystream
              </div>

            </div><!-- #document-body -->
            <aside data-tile="${container/absolute_url}/@@sidebar.default"
                   tal:define="container context/@@plone_context_state/folder"
                   tal:condition="view/show_sidebar"></aside>
          </div>
          <nav class="navigation workspace-tabs" id="workspace-tabs" data-tile="./@@workspace.tabs.tile" tal:attributes="data-tile string:${workspace_url}/@@workspace.tabs.tile" />
          <div id="share-panel" hidden style="display:none">
            <ul class="menu">
              <li tal:condition="python:context.portal_type in ('File', 'Image')">
                <a href="${context/absolute_url}/download" class="icon-file-word" tal:attributes="class view/icon_class"><tal:label i18n:translate="">Download as</tal:label> <tal:type replace="view/content_type_name"/></a>
              </li>
              <li>
                <a class="icon-print" href="javascript:window.print()" i18n:translate="">Print</a>
              </li>
              <li tal:condition="view/can_publish_widely">
                <a class="icon-feather pat-modal"
                   href="${context/absolute_url}/panel-publish-to-library#document-content"
                   i18n:translate="">Publish to library</a>
                </li>
            </ul>
          </div>

        </div>
      </div>
    </metal:content>
  </body>
</html>
